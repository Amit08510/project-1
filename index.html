<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration (Full stack)</title>

    <!-- CDN for Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- CDN for Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body class="bg-light">
    <div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
      <div class="row w-100 justify-content-center">
        <!-- Form Column (50%) -->
        <div class="col-md-5">
          <div class="card shadow p-4">
            <h2 class="text-center mb-4">Register</h2>
            <form id="registerForm">
              <!-- Full Name -->
              <div class="mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" placeholder="Enter your name" required>
              </div>

              <!-- Email -->
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
              </div>

              <!-- Password -->
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter password" required>
              </div>

              <!-- Confirm Password -->
              <div class="mb-3">
                <label for="confirm" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="confirm" placeholder="Confirm password" required>
              </div>

              <!-- Submit -->
              <button type="submit" class="btn btn-dark w-100">Register</button>
            </form>
          </div>
        </div>

        <!-- Output Column (50%) -->
        <div class="col-md-5">
          <div class="card shadow p-4 h-100">
            <h2 class="text-center mb-4">Registered Users</h2>
            <div id="output">
              <div id="usersList" class="overflow-auto" style="max-height: 350px;">
                <!-- Users will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://localhost:5000";

      const form = document.getElementById("registerForm");
      const usersList = document.getElementById("usersList");

      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // prevent page reload

        // get form values
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const confirm = document.getElementById("confirm").value;

        // Validate form fields
        if (!name || !email || !password || !confirm) {
          alert("Please fill in all fields!");
          return;
        }

        // checking password and confirm password match or not 
        if (password !== confirm) {
          alert("Passwords do not match!");
          return;
        }

        try {
          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.textContent;
          submitBtn.textContent = "Registering...";
          submitBtn.disabled = true;

          // POST: /api/users/register
          const response = await axios.post(`${BASE_URL}/api/users/register`, {
            name,
            email,
            password
          });


          alert("User registered successfully!");

          // Clear form
          form.reset();

          // Refresh the users list
          fetchUsers();
        } catch (error) {
          console.error("Registration error:", error);
          if (error.response) {
            alert(error.response.data?.message || "Registration failed");
          } else if (error.request) {
            alert("Network error. Please check if the server is running.");
          } else {
            alert("An unexpected error occurred");
          }
        } finally {
          // Restoring back button state
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.textContent = "Register";
          submitBtn.disabled = false;
        }
      });

      // Fetch users from Database and show in output div
      async function fetchUsers() {
        try {
          const response = await axios.get(`${BASE_URL}/api/users`);
          console.log("Users:", response.data);

          // Clear the current list
          usersList.innerHTML = '';

          // Check if there are users if not showing <p>
          if (response.data.length === 0) {
            usersList.innerHTML = '<p class="text-center text-muted">No users registered yet.</p>';
            return;
          }

          // Create a table to display users
          const table = document.createElement('table');
          table.className = 'table table-striped';

          // Create table header
          const thead = document.createElement('thead');
          thead.innerHTML = `
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>ID</th>
                    </tr>
                `;
          table.appendChild(thead);

          // Create table body
          const tbody = document.createElement('tbody');

          // Add each user as a row
          response.data.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td class="small text-muted">${user._id.substring(0, 8)}...</td>
                    `;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          usersList.appendChild(table);

        } catch (error) {
          console.error("Error fetching users:", error);
          usersList.innerHTML = '<p class="text-center text-danger">Error loading users.</p>';
        }
      }

      // Fetch users on page load
      document.addEventListener('DOMContentLoaded', fetchUsers);
    </script>
  </body>

</html>
